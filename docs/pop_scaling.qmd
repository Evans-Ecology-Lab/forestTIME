---
title: "Untitled"
format: html
---

Following the 'rFIA demystified' [vignette](https://doserlab.com/files/rfia/articles/fiademystified#with-sampling-errors) on estimation at the population level with sampling errors, but with interpolation and extrapolation to annualize data.

The sections below are intended to represent chunks that could be turned into functions, e.g. `expand_time()`, `interpolate_data()`, `estimate_carbon()`, etc.

```{r}
#| label: setup
library(rFIA)
library(readr)
library(here)
library(purrr)
library(dplyr)

source("../R/get_fia_tables.R")
source("../R/prep_data.R")
source("../R/expand_data.R")
source("../R/step_interp.R")
source("../R/inter_extra_polate.R")
source("../R/interpolate_data.R")
source("../R/adjust_mortality.R")
source("../R/prep_carbon.R")
source("../R/estimate_carbon.R")
```

## Data Download

```{r}
get_fia_tables(
  states = c("RI", "DE", "CO", "OR"),
  keep_zip = TRUE
)
```

## Data Preparation

I need to make sure I have all the columns for population estimation *and* all the columns for carbon estimation using the walker code (documented better in `annual_carbon_estimation.qmd`).

```{r}
db <- read_fia(states = "DE")
names(db)
```

Get the columns needed into a single table

```{r}
data <- prep_data(db)
```

Check that each tree has only 1 entry per year

```{r}
data |> 
  group_by(tree_ID, INVYR) |> 
  summarise(n = n()) |> filter(n > 1)
```

## Expand

Here's where I'll expand to include all years and then fill any time-invariant columns

```{r}
data_expanded <- expand_data(data)
```

## Interpolate

Then I'll apply the interpolation functions here.
This also joins in the `TPA_UNADJ` column based on "rules" from `DESIGNCD`.

::: callout-important
Still need to figure out how to interpolate some variables:\
<https://github.com/mekevans/forestTIME-builder/issues/64>
:::

```{r}
data_interpolated <- interpolate_data(data_expanded)
```

## Adjust for mortality

Then we'll adjust all columns related to mortality (`STATUSCD`, `STANDING_DEAD_CD`, `DECAYCD`, and dimensions like `DIA`, `HT`, etc.)

::: callout-note
I double-checked, and the warning this gives can be ignored safely.
It happens when trees aren't ever marked as dead (`STATUSCD==2`) and results in a "first dead" year of `NA`, which is appropriate.
:::

```{r}
data_mortyr <- adjust_mortality(data_interpolated, use_mortyr = TRUE)
data_midpt <- adjust_mortality(data_interpolated, use_mortyr = FALSE)
```

After this, can join REF tables

## Prep for Carbon Estimation

Join REF tables and such

```{r}
data_mortyr_prepped <- prep_carbon(data_mortyr)
data_midpt_prepped <- prep_carbon(data_midpt)
```

## Estimate carbon

Here, our table will get run through the david walker code (which, ideally will be turned into a function)

```{r}
carbon_midpt <- estimate_carbon(data_midpt_prepped)
carbon_mortyr <- estimate_carbon(data_mortyr_prepped)
```

::: callout-important
Still to-do: remove unneeded columns from this output!
:::

## Plot level sums

Get tree and area attributes as outlined in rFIA vignette

## Strata level

Then summarize by stratum

## Population level

Then sum attributes across estimation units for region of interest
