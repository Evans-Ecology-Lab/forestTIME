---
title: "Untitled"
format: html
---

Following the 'rFIA demystified' [vignette](https://doserlab.com/files/rfia/articles/fiademystified#with-sampling-errors) on estimation at the population level with sampling errors, but with interpolation and extrapolation to annualize data.

The sections below are intended to represent chunks that could be turned into functions, e.g. `expand_time()`, `interpolate_data()`, `estimate_carbon()`, etc.

```{r}
#| label: setup
library(rFIA)
library(readr)
library(here)
library(purrr)
library(dplyr)

source("../R/get_fia_tables.R")
source("../R/prep_data.R")
source("../R/expand_data.R")
source("../R/step_interp.R")
source("../R/inter_extra_polate.R")
source("../R/interpolate_data.R")
```

## Data Download

```{r}
get_fia_tables(
  states = c("RI", "DE", "CO", "OR"),
  keep_zip = TRUE
)
```

## Data Preparation

I need to make sure I have all the columns for population estimation *and* all the columns for carbon estimation using the walker code (documented better in `annual_carbon_estimation.qmd`).

```{r}
db <- read_fia(states = "RI")
names(db)
```

Get the columns needed into a single table

```{r}
data <- prep_data(db)
```

Check that each tree has only 1 entry per year

```{r}
data |> 
  group_by(tree_ID, INVYR) |> 
  summarise(n = n()) |> filter(n > 1)
```

## Expand

Here's where I'll expand to include all years and then fill any time-invariant columns

```{r}
data_expanded <- expand_data(data)
```

## Interpolate

Then I'll apply the interpolation functions here.

::: callout-important
Still need to figure out how to interpolate some variables:\
<https://github.com/mekevans/forestTIME-builder/issues/64>
:::

```{r}
data_interpolated <- interpolate_data(data_expanded)
```

## TPA_UNADJ

Then we'll merge in TPA_UNADJ based on rules Dani has figured out

```{r}

```

## Adjust for mortality

Then we'll adjust all columns related to mortality (`STATUSCD`, `STANDING_DEAD_CD`, `DECAYCD`, and dimensions like `DIA`, `HT`, etc.)

```{r}

```

After this, can join REF tables

## Prep for Carbon Estimation

Join REF tables and such

## Estimate carbon

Here, our table will get run through the david walker code (which, ideally will be turned into a function)

```{r}

```

## Plot level sums

Get tree and area attributes as outlined in rFIA vignette

## Strata level

Then summarize by stratum

## Population level

Then sum attributes across estimation units for region of interest
