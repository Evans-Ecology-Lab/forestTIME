---
title: "Untitled"
format: html
---

```{r}
#| label: setup
#| include: false
library(DBI)
library(duckdb)
library(dplyr)
library(here)
```

```{r}
#| label: connect
con <- 
  dbConnect(duckdb(here("data/db/foresttime-from-state-parquet.duckdb")))
(tables <- dbListTables(con))
```

```{r}
#| label: tables
tree_carbon <- tbl(con, "tree_carbon_annualized_mortyr")
tree <- tbl(con, "tree")
plot <- tbl(con, "plot")
```

Filter to just Rhode Island for exploration

```{r}
tree_carbon_ri <- 
  tree_carbon |> 
  filter(STATECD == 44) |> 
  collect()
```

Figure out the "rules" for trees per acre

```{r}
tree |> 
  filter(INVYR >= 2000) |> 
  group_by(TPA_UNADJ) |> 
  summarize(
    min_dia = min(DIA, na.rm = TRUE),
    max_dia = max(DIA, na.rm = TRUE),
    n = n()
  ) |> 
  collect() |> 
  arrange(desc(n))
```

Ok, so it's *not* just 3 possibilities, rounding issues aside, and there are a bunch of `NA`s.

According to the green book, $TPA = 1/(N*A)$ where $N$ is the number of subplots and $A$ is the area of each subplot.
The only applies to fixed-radius plot designs.

Let's load the plot table and figure this out

```{r}
# plot_ri <-
  plot |> 
    filter(INVYR >= 2000) |> 
    # filter(STATECD == 44) |> 
    # filter(DESIGNCD == 1) |>
    collect() |> 
    count(DESIGNCD) |> 
    arrange(desc(n)) |> write_csv("design_codes.csv")
```

```{r}
df <- tribble(~DESIGNCD, ~min_DIA, ~max_DIA, ~TPA_2,
        1, 1, 4.99, 74.96,
        1, 5, Inf, 6.02,
        )
df
tree_carbon |> 
  left_join(tree |> select(TREE_COMPOSITE_ID, PLOT_COMPOSITE_ID)) |> 
  left_join(plot |> select(PLOT_COMPOSITE_ID, DESIGNCD)) |> 
  filter(STATECD == 44) |>
  collect() |> 
  left_join(df, by = join_by(DESIGNCD, between(DIA, min_DIA, max_DIA))) |>
  select(TPA_2, DESIGNCD, DIA, everything()) |> 
  View()
```

Ok, so for fixed radius plots (`plot$DESIGNCD == 1`), `TPA_UNADJ` should be 6.018046 for subplots, 74.965282 for microplots, and 0.999188 for macroplots.

> 3.1.92 TPA_UNADJ
>
> **Trees per acre unadjusted**.
> The number of trees per acre that the sample tree theoretically represents based on the sample design.
> For fixed-radius plots taken with the mapped plot design (PLOT.DESIGNCD = 1), TPA_UNADJ is set to a constant derived from the plot size and equals 6.018046 for trees sampled on subplots, 74.965282 for trees sampled on microplots, and 0.999188 for trees sampled on macroplots.
> Variable-radius plots were often used in earlier inventories, so the value in TPA_UNADJ decreases as the tree diameter increases.
> Based on the procedures described in Bechtold and Patterson (2005), this attribute must be adjusted using factors stored in the POP_STRATUM table to derive population estimates.
> Examples of estimating population totals are shown in The Forest Inventory and Analysis Database: Population Estimation User Guide.

--FIADB User Guide 3-35

I'm not sure how to figure out if a tree is in a subplot, microplot, or macroplot though.

1 - 4.99 is microplot

â‰¥5 is subplot

```{r}
unzip(here("data/rawdat/state"))
```
